<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Control - Bot Discord</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f4f7f6; font-family: 'Segoe UI', sans-serif; }
        .sidebar { min-height: 100vh; background: #2c3e50; color: white; position: fixed; width: inherit; }
        .nav-link { color: rgba(255,255,255,0.7); cursor: pointer; border-radius: 5px; margin-bottom: 5px; }
        .nav-link:hover, .nav-link.active { color: white; background: rgba(255,255,255,0.1); }
        .main-content { margin-left: 16.66667%; padding: 20px; }
        .card { border: none; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .view-section { display: none; }
        .view-section.active { display: block; }
        .chat-msg { padding: 10px; border-radius: 8px; margin-bottom: 10px; }
        .msg-user { background: #e3f2fd; align-self: flex-end; }
        .msg-bot { background: #f1f1f1; }
    </style>
</head>
<body>

<div class="container-fluid">
    <div class="row">
        <nav class="col-md-2 d-none d-md-block sidebar p-3">
            <h4 class="text-center mb-4"> Bot Panel</h4>
            <ul class="nav flex-column">
                <li class="nav-item"><a class="nav-link active" onclick="showSection('resumen')"><i class="fas fa-chart-line me-2"></i> Resumen</a></li>
                <li class="nav-item"><a class="nav-link" onclick="showSection('historial')"><i class="fas fa-history me-2"></i> Historial</a></li>
                <li class="nav-item"><a class="nav-link" onclick="showSection('config')"><i class="fas fa-cog me-2"></i> Configuraci贸n</a></li>
            </ul>
        </nav>

        <main class="col-md-10 main-content">
            
            <section id="resumen" class="view-section active">
                <div class="d-flex justify-content-between mb-4">
                    <h2>Panel de Actividad</h2>
                    <button class="btn btn-outline-primary btn-sm" onclick="refreshData()"><i class="fas fa-sync"></i></button>
                </div>
                <div class="row">
                    <div class="col-md-4">
                        <div class="card p-3 text-center">
                            <h6 class="text-muted">Mensajes Totales</h6>
                            <h2 id="totalMessages">0</h2>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card p-3 text-center">
                            <h6 class="text-muted">Latencia</h6>
                            <h2 id="avgTime">0s</h2>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card p-3 text-center">
                            <h6 class="text-muted">Usuarios</h6>
                            <h2 id="totalUsers">0</h2>
                        </div>
                    </div>
                </div>
                <div class="card p-4">
                    <canvas id="activityChart" height="100"></canvas>
                </div>
            </section>

            <section id="historial" class="view-section">
                <div class="row">
                    <div class="col-md-4">
                        <div class="card p-3">
                            <h5>Chats Guardados</h5>
                            <div id="chatList" class="list-group list-group-flush">
                                </div>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="card p-3">
                            <h5>Visor de Mensajes</h5>
                            <div id="chatViewer" style="height: 500px; overflow-y: auto; padding: 15px; background: #fff; border: 1px solid #eee; border-radius: 8px;">
                                <p class="text-center text-muted mt-5">Selecciona un chat para ver la conversaci贸n</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="config" class="view-section">
                <div class="card p-4">
                    <h5>锔 Configuraci贸n del Sistema</h5>
                    <hr>
                    <form id="configForm">
                        <div class="mb-3">
                            <label class="form-label">Modelo de Ollama</label>
                            <input type="text" class="form-control" value="llama3.2" readonly>
                        </div>
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="gpuCheck" checked>
                            <label class="form-check-label" for="gpuCheck">Aceleraci贸n por GPU</label>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Nivel de Logging</label>
                            <select class="form-select">
                                <option>Informativo (Default)</option>
                                <option>Debug (Detallado)</option>
                                <option>Solo Errores</option>
                            </select>
                        </div>
                        <button type="button" class="btn btn-primary" onclick="alert('Configuraci贸n guardada (Simulado)')">Guardar Cambios</button>
                    </form>
                </div>
            </section>

        </main>
    </div>
</div>

<script>
    let activityChart = null;

    function showSection(sectionId) {
        document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        
        document.getElementById(sectionId).classList.add('active');
        event.currentTarget.classList.add('active');

        if(sectionId === 'historial') loadHistories();
    }

    async function loadHistories() {
        const response = await fetch('/api/chats');
        const data = await response.json();
        const chatList = document.getElementById('chatList');
        chatList.innerHTML = '';

        for (const [userId, chats] of Object.entries(data)) {
            for (const [chatName, info] of Object.entries(chats)) {
                const item = document.createElement('button');
                item.className = 'list-group-item list-group-item-action';
                item.innerHTML = `<strong>${chatName}</strong><br><small class="text-muted">User: ${userId}</small>`;
                item.onclick = () => viewChat(userId, chatName);
                chatList.appendChild(item);
            }
        }
    }

    async function viewChat(userId, chatName) {
        const response = await fetch(`/api/chat/${userId}/${chatName}`);
        const data = await response.json();
        const viewer = document.getElementById('chatViewer');
        
        viewer.innerHTML = data.messages.map(m => `
            <div class="chat-msg ${m.role === 'user' ? 'msg-user' : 'msg-bot'}">
                <strong>${m.role === 'user' ? ' T煤' : ' Bot'}:</strong><br>${m.content}
            </div>
        `).join('');
    }

    async function refreshData() {
        const response = await fetch('/api/stats/summary');
        const stats = await response.json();
        
        document.getElementById('totalMessages').innerText = stats.total_messages;
        document.getElementById('avgTime').innerText = stats.avg_response_time.toFixed(2) + 's';
        document.getElementById('totalUsers').innerText = stats.total_users;

        const ctx = document.getElementById('activityChart').getContext('2d');
        if (activityChart) activityChart.destroy();
        activityChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                datasets: [{
                    label: 'Mensajes por hora',
                    data: stats.hourly_activity || Array(24).fill(0),
                    borderColor: '#3498db',
                    tension: 0.3,
                    fill: true,
                    backgroundColor: 'rgba(52,152,219,0.1)'
                }]
            }
        });
    }

    window.onload = refreshData;
</script>
</body>
</html>